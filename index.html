<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- GoatCounter script for counting pageviews -->
    <script data-goatcounter="https://linsnotes.goatcounter.com/count" async src="https://gc.zgo.at/count.js"></script>
    <style>
        :root {
            --primary-color: #0071e3;
            --error-color: #ff3b30;
            --success-color: #34c759;
            --gray-light: #f5f5f7;
            --gray-medium: #d2d2d7;
            --gray-dark: #86868b;
            --text-color: #1d1d1f;
            --background-color: #ffffff;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'San Francisco', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        header.hidden {
            display: none;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        h2 {
            font-size: 1.75rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            letter-spacing: -0.01em;
        }

        h3 {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        p {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--gray-dark);
        }

        .screen {
            display: none;
            padding: 2rem;
            background-color: var(--background-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            animation: fadeIn 0.5s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input[type="text"] {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 1px solid var(--gray-medium);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 113, 227, 0.3);
        }

        .btn {
            display: inline-block;
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .btn:hover {
            background-color: #0058b0;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background-color: var(--gray-light);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: var(--gray-medium);
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .center-btn {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 113, 227, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .question-card {
            margin-bottom: 2rem;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .question-number {
            font-size: 0.875rem;
            color: var(--gray-dark);
        }

        .timer {
            font-size: 0.875rem;
            color: var(--gray-dark);
        }

        .submit-wrapper {
            text-align: center;
        }

        .submit-header-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: 20px;
        }

        .question-text {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
        }

        .background-info {
            background-color: var(--gray-light);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            font-style: normal;
        }

        .mcq-options {
            display: grid;
            gap: 1rem;
        }

        .mcq-option {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--gray-medium);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .mcq-option:hover {
            background-color: var(--gray-light);
        }

        .mcq-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 113, 227, 0.1);
        }

        .mcq-option-letter {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 30px;
            height: 30px;
            background-color: var(--gray-light);
            border-radius: 50%;
            margin-right: 0.75rem;
            font-weight: 500;
        }

        .typing-answer {
            margin-top: 1rem;
        }

        .hint-container,
        .explanation-container {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: var(--border-radius);
            background-color: var(--gray-light);
            display: none;
        }

        .hint-container.active,
        .explanation-container.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .result-summary {
            text-align: center;
            margin-bottom: 2rem;
        }

        .result-score {
            font-size: 3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-detail-card {
            padding: 1.5rem;
            background-color: var(--gray-light);
            border-radius: var(--border-radius);
            text-align: center;
        }

        .result-detail-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .result-detail-label {
            font-size: 0.875rem;
            color: var(--gray-dark);
        }

        .review-question {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            background-color: var(--gray-light);
        }

        .review-question.correct {
            border-left: 4px solid var(--success-color);
        }

        .review-question.incorrect {
            border-left: 4px solid var(--error-color);
        }

        .review-answer {
            margin-top: 1rem;
            font-weight: 500;
        }

        .review-answer.correct {
            color: var(--success-color);
        }

        .review-answer.incorrect {
            color: var(--error-color);
        }

        .review-explanation {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-medium);
        }

        /* Visitor counter styles */
        #visitor-counter {
            display: inline-block;
            margin: 0.5rem auto 1rem;
            padding: 0.4rem 1rem;
            background-color: var(--gray-light);
            border-radius: 20px;
            font-size: 0.875rem;
            color: var(--gray-dark);
            transition: var(--transition);
        }

        #pageviews {
            font-weight: 600;
            color: var(--primary-color);
            position: relative;
        }

        #pageviews.loading {
            animation: pulse 1.5s infinite ease-in-out;
            padding: 0;
            display: inline;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.5rem;
            }

            .container {
                padding: 1rem;
            }

            .screen {
                padding: 1.5rem;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .result-details {
                grid-template-columns: 1fr;
            }

            .navigation-buttons {
                flex-direction: column;
                gap: 1rem;
            }

            .question-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .submit-wrapper {
                margin-top: 0.5rem;
                width: 100%;
            }

            .submit-header-btn {
                width: 100%;
            }
        }

        #studentName {
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="container">
        <header id="appHeader">
            <h1>Quiz App</h1>
            <div id="visitor-counter">
                <span>Welcome!</span> <span id="pageviews" class="loading">Loading...</span> <span>visits</span>
            </div>
        </header>

        <div id="welcomeScreen" class="screen active">
            <h2>Welcome to the Quiz App</h2>
            <div class="input-group">
                <label for="nameInput">Your Name</label>
                <input type="text" id="nameInput" placeholder="Enter your name">
            </div>
            <div class="input-group">
                <label for="sheetIdInput">Quiz ID</label>
                <input type="text" id="sheetIdInput" placeholder="Enter the Quiz ID">
                <p>Please obtain the Quiz ID from your teacher.</p>
            </div>
            <div class="center-btn">
                <button id="startQuizBtn" class="btn">Start Quiz</button>
            </div>
        </div>

        <div id="loadingScreen" class="screen">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading questions...</p>
            </div>
        </div>

        <div id="questionScreen" class="screen">
            <div class="question-header">
                <div class="question-number">Question <span id="currentQuestionNumber">1</span> of <span
                        id="totalQuestions">10</span></div>
                <div class="submit-wrapper">
                    <button id="submitAllBtn" class="btn submit-header-btn">Submit All Answers</button>
                </div>
                <div class="timer">Time: <span id="timerValue">00:00</span></div>
            </div>
            <div class="question-card">
                <div id="backgroundInfo" class="background-info" style="display: none;"></div>
                <div id="questionText" class="question-text"></div>
                <div id="mcqOptions" class="mcq-options"></div>
                <div id="typingAnswer" class="typing-answer" style="display: none;">
                    <input type="text" id="answerInput" placeholder="Type your answer here">
                </div>
                <div id="hintContainer" class="hint-container">
                    <h3>Hint:</h3>
                    <p id="hintText"></p>
                </div>
                <div class="navigation-buttons">
                    <button id="prevQuestionBtn" class="btn btn-secondary">Previous</button>
                    <button id="showHintBtn" class="btn btn-secondary">Show Hint</button>
                    <button id="nextQuestionBtn" class="btn btn-secondary">Next</button>
                </div>
            </div>
        </div>

        <div id="resultScreen" class="screen">
            <div class="result-summary">
                <h2>Quiz Results</h2>
                <p>Well done, <span id="studentName"></span>!</p>
                <div class="result-score"><span id="correctAnswers">0</span>/<span id="totalQuestionsResult">0</span>
                </div>
            </div>
            <div class="result-details">
                <div class="result-detail-card">
                    <div class="result-detail-value" id="totalQuestionsAttempted">0</div>
                    <div class="result-detail-label">Questions Attempted</div>
                </div>
                <div class="result-detail-card">
                    <div class="result-detail-value" id="correctAnswersCount">0</div>
                    <div class="result-detail-label">Correct Answers</div>
                </div>
                <div class="result-detail-card">
                    <div class="result-detail-value" id="incorrectAnswersCount">0</div>
                    <div class="result-detail-label">Incorrect Answers</div>
                </div>
                <div class="result-detail-card">
                    <div class="result-detail-value" id="timeSpent">00:00</div>
                    <div class="result-detail-label">Time Spent</div>
                </div>
            </div>
            <div class="btn-group">
                <button id="screenshotBtn" class="btn">Screenshot Result</button>
                <button id="reviewBtn" class="btn">Review All Questions</button>
                <button id="homeBtn" class="btn">Back to Home</button>
            </div>
        </div>

        <div id="reviewScreen" class="screen">
            <h2>Review All Questions</h2>
            <div id="reviewContainer"></div>
            <div class="btn-group">
                <button id="backToResultsBtn" class="btn">Back to Results</button>
                <button id="reviewHomeBtn" class="btn">Back to Home</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const appHeader = document.getElementById('appHeader');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const loadingScreen = document.getElementById('loadingScreen');
        const questionScreen = document.getElementById('questionScreen');
        const resultScreen = document.getElementById('resultScreen');
        const reviewScreen = document.getElementById('reviewScreen');

        const nameInput = document.getElementById('nameInput');
        const sheetIdInput = document.getElementById('sheetIdInput');
        const startQuizBtn = document.getElementById('startQuizBtn');

        const currentQuestionNumber = document.getElementById('currentQuestionNumber');
        const totalQuestions = document.getElementById('totalQuestions');
        const timerValue = document.getElementById('timerValue');
        const backgroundInfo = document.getElementById('backgroundInfo');
        const questionText = document.getElementById('questionText');
        const mcqOptions = document.getElementById('mcqOptions');
        const typingAnswer = document.getElementById('typingAnswer');
        const answerInput = document.getElementById('answerInput');
        const prevQuestionBtn = document.getElementById('prevQuestionBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const showHintBtn = document.getElementById('showHintBtn');
        const submitAllBtn = document.getElementById('submitAllBtn');
        const hintContainer = document.getElementById('hintContainer');
        const hintText = document.getElementById('hintText');

        const studentName = document.getElementById('studentName');
        const totalQuestionsResult = document.getElementById('totalQuestionsResult');
        const totalQuestionsAttempted = document.getElementById('totalQuestionsAttempted');
        const correctAnswers = document.getElementById('correctAnswers');
        const correctAnswersCount = document.getElementById('correctAnswersCount');
        const incorrectAnswersCount = document.getElementById('incorrectAnswersCount');
        const timeSpent = document.getElementById('timeSpent');
        const screenshotBtn = document.getElementById('screenshotBtn');
        const reviewBtn = document.getElementById('reviewBtn');
        const homeBtn = document.getElementById('homeBtn');

        const reviewContainer = document.getElementById('reviewContainer');
        const backToResultsBtn = document.getElementById('backToResultsBtn');
        const reviewHomeBtn = document.getElementById('reviewHomeBtn');

        // App State
        let questions = [];
        let currentQuestion = 0;
        let startTime;
        let timerInterval;
        let userAnswers = [];
        let quizCompleted = false;
        let hintVisible = false;

        // Event Listeners
        startQuizBtn.addEventListener('click', startQuiz);
        prevQuestionBtn.addEventListener('click', showPreviousQuestion);
        nextQuestionBtn.addEventListener('click', showNextQuestion);
        showHintBtn.addEventListener('click', toggleHint);
        submitAllBtn.addEventListener('click', submitAllAnswers);
        screenshotBtn.addEventListener('click', takeScreenshot);
        reviewBtn.addEventListener('click', showReviewScreen);
        homeBtn.addEventListener('click', goToHome);
        backToResultsBtn.addEventListener('click', backToResults);
        reviewHomeBtn.addEventListener('click', goToHome);

        // Functions
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screen.classList.add('active');

            // Hide the header for all screens except welcome screen
            if (screen === welcomeScreen) {
                appHeader.classList.remove('hidden');
            } else {
                appHeader.classList.add('hidden');
            }
        }

        async function startQuiz() {
            const name = nameInput.value.trim();
            const sheetId = sheetIdInput.value.trim();

            if (!name) {
                alert('Please enter your name');
                return;
            }

            if (!sheetId) {
                alert('Please enter a Google Sheet ID');
                return;
            }

            showScreen(loadingScreen);
            studentName.textContent = name;

            try {
                const data = await fetchQuestionData(sheetId);
                if (data && data.length > 0) {
                    questions = data;
                    totalQuestions.textContent = questions.length;
                    totalQuestionsResult.textContent = questions.length;

                    // Initialize user answers array
                    userAnswers = Array(questions.length).fill(null);

                    // Start timer
                    startTime = new Date();
                    startTimer();

                    // Show first question
                    showQuestion(0);
                    showScreen(questionScreen);
                } else {
                    alert('No questions found in the sheet. Please check the Sheet ID and try again.');
                    showScreen(welcomeScreen);
                }
            } catch (error) {
                console.error('Error fetching questions:', error);
                alert('Error loading questions. Please check the Sheet ID and try again.');
                showScreen(welcomeScreen);
            }
        }

        async function fetchQuestionData(sheetId) {
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=xlsx`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Failed to fetch spreadsheet');
                }

                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });

                // Get the first sheet
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                // If no data, return empty array
                if (!jsonData || jsonData.length === 0) {
                    return [];
                }
                
                // Define the expected column order
                const expectedOrder = [
                    'no',              // Question number
                    'question',        // Question text
                    'answer',          // Answer
                    'type',            // Question type
                    'mcqOptions',      // Multiple choice options
                    'readingMaterial', // Reading material (formerly backgroundInfo)
                    'hint',            // Hint
                    'explanation'      // Explanation
                ];
                
                // Map the data based on column position
                return jsonData.map(row => {
                    const rowData = {};
                    const rowKeys = Object.keys(row);
                    
                    // Map by position first
                    expectedOrder.forEach((field, index) => {
                        if (index < rowKeys.length) {
                            rowData[field] = row[rowKeys[index]];
                        }
                    });
                    
                    // Fallback to header names if available (for backward compatibility)
                    rowData.no = rowData.no || row.No || row.no;
                    rowData.question = rowData.question || row.Question || row.question;
                    rowData.answer = rowData.answer || row.Answer || row.answer;
                    rowData.type = rowData.type || row.Type || row['Question Type'] || row.type || row.questionType;
                    rowData.mcqOptions = rowData.mcqOptions || row['MCQ Options'] || row.mcqOptions || row.options;
                    rowData.readingMaterial = rowData.readingMaterial || row['Reading Material'] || row['Background Info'] || row.backgroundInfo || row.readingMaterial;
                    rowData.hint = rowData.hint || row.Hint || row.hint;
                    rowData.explanation = rowData.explanation || row.Explanation || row.explanation;
                    
                    return rowData;
                });
            } catch (error) {
                console.error('Error fetching or parsing the spreadsheet:', error);
                throw error;
            }
        }

        function showQuestion(index) {
            if (index < 0) {
                index = 0;
            } else if (index >= questions.length) {
                index = questions.length - 1;
            }

            const question = questions[index];
            currentQuestion = index;
            currentQuestionNumber.textContent = index + 1;

            // Reset UI elements
            mcqOptions.innerHTML = '';
            typingAnswer.style.display = 'none';
            hintContainer.classList.remove('active');
            hintVisible = false;
            showHintBtn.textContent = 'Show Hint';

            // Set question text
            questionText.textContent = question.question;

            // Set reading material if available
            if (question.readingMaterial && question.readingMaterial.trim() !== '') {
                backgroundInfo.textContent = question.readingMaterial;
                backgroundInfo.style.display = 'block';
            } else {
                backgroundInfo.style.display = 'none';
            }

            // Set hint text
            hintText.textContent = question.hint && question.hint.toLowerCase() !== "none" ? 
                question.hint : "No hints are provided for this question.";

            // Update navigation buttons
            prevQuestionBtn.disabled = index === 0;
            nextQuestionBtn.disabled = index === questions.length - 1;

            // Render question based on type
            if (question.type === 'MCQ') {
                renderMCQQuestion(question);
            } else {
                renderTypingQuestion(index);
            }
        }

        function renderMCQQuestion(question) {
            // Split MCQ options
            let options = question.mcqOptions.split('#');
            const correctAnswer = question.answer;

            // Create array of options with fixed A, B, C, D labels but shuffled content
            const shuffledOptions = [];

            // Create a copy of options array to shuffle
            const optionsCopy = [...options];

            // Shuffle the options
            for (let i = optionsCopy.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [optionsCopy[i], optionsCopy[j]] = [optionsCopy[j], optionsCopy[i]];
            }

            // Assign shuffled options to A, B, C, D
            const letters = ['A', 'B', 'C', 'D'];
            for (let i = 0; i < optionsCopy.length; i++) {
                shuffledOptions.push({
                    letter: letters[i],
                    option: optionsCopy[i],
                    isCorrect: optionsCopy[i].toLowerCase() === correctAnswer.toLowerCase()
                });
            }

            // Render options
            shuffledOptions.forEach((optionObj) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'mcq-option';
                optionElement.dataset.option = optionObj.option;
                optionElement.dataset.letter = optionObj.letter;

                const letterElement = document.createElement('div');
                letterElement.className = 'mcq-option-letter';
                letterElement.textContent = optionObj.letter;

                const textElement = document.createElement('div');
                textElement.className = 'mcq-option-text';
                textElement.textContent = optionObj.option;

                optionElement.appendChild(letterElement);
                optionElement.appendChild(textElement);

                // Check if this option was previously selected
                if (userAnswers[currentQuestion] &&
                    userAnswers[currentQuestion].userAnswer.toLowerCase() === optionObj.option.toLowerCase()) {
                    optionElement.classList.add('selected');
                }

                optionElement.addEventListener('click', () => {
                    document.querySelectorAll('.mcq-option').forEach(el => el.classList.remove('selected'));
                    optionElement.classList.add('selected');

                    // Save this answer
                    saveUserAnswer(optionObj.option);
                });

                mcqOptions.appendChild(optionElement);
            });
        }

        function renderTypingQuestion(index) {
            typingAnswer.style.display = 'block';

            // Set previous answer if exists
            if (userAnswers[index] && userAnswers[index].userAnswer) {
                answerInput.value = userAnswers[index].userAnswer;
            } else {
                answerInput.value = '';
            }

            answerInput.focus();

            // Add input event listener to save answer as user types
            answerInput.oninput = () => {
                saveUserAnswer(answerInput.value);
            };
        }

        function saveUserAnswer(answer) {
            if (currentQuestion >= questions.length) return;

            const question = questions[currentQuestion];

            // Check correctness
            let isCorrect = false;
            const userAnswer = answer.trim();
            const correctAnswer = question.answer;

            // For numerical answers, check if both can be parsed as numbers
            if (!isNaN(parseFloat(userAnswer)) && !isNaN(parseFloat(correctAnswer))) {
                isCorrect = parseFloat(userAnswer) === parseFloat(correctAnswer);
            } else {
                // Case-insensitive string comparison
                isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
            }

            // Save user answer
            userAnswers[currentQuestion] = {
                questionNo: question.no,
                questionText: question.question,
                userAnswer,
                correctAnswer: question.answer,
                isCorrect,
                questionType: question.type,
                explanation: question.explanation
            };
        }

        function showPreviousQuestion() {
            if (currentQuestion === 0) {
                alert("This is the first question.");
                return;
            }
            showQuestion(currentQuestion - 1);
        }

        function showNextQuestion() {
            if (currentQuestion === questions.length - 1) {
                alert("This is the last question. If you have completed all questions, you can click the 'Submit All Answers' button to end the quiz.");
                return;
            }
            showQuestion(currentQuestion + 1);
        }

        function toggleHint() {
            hintVisible = !hintVisible;

            if (hintVisible) {
                hintContainer.classList.add('active');
                showHintBtn.textContent = 'Hide Hint';
            } else {
                hintContainer.classList.remove('active');
                showHintBtn.textContent = 'Show Hint';
            }
        }

        function submitAllAnswers() {
            // Check if user has answered all questions
            const unanswered = userAnswers.findIndex(answer => answer === null);

            if (unanswered !== -1) {
                const confirmSubmit = confirm(`You haven't answered question ${unanswered + 1}. Do you want to submit anyway?`);
                if (!confirmSubmit) {
                    showQuestion(unanswered);
                    return;
                }
            }

            finishQuiz();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const now = new Date();
                const elapsedMilliseconds = now - startTime;
                const elapsedSeconds = Math.floor(elapsedMilliseconds / 1000);
                const minutes = Math.floor(elapsedSeconds / 60);
                const seconds = elapsedSeconds % 60;
                timerValue.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function finishQuiz() {
            stopTimer();
            quizCompleted = true;

            // Calculate results
            const totalAttempted = userAnswers.filter(answer => answer !== null).length;
            const correct = userAnswers.filter(answer => answer && answer.isCorrect).length;
            const incorrect = totalAttempted - correct;

            // Update result screen
            totalQuestionsAttempted.textContent = totalAttempted;
            correctAnswers.textContent = correct;
            correctAnswersCount.textContent = correct;
            incorrectAnswersCount.textContent = incorrect;

            // Calculate time spent
            const endTime = new Date();
            const elapsedMilliseconds = endTime - startTime;
            const elapsedSeconds = Math.floor(elapsedMilliseconds / 1000);
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            timeSpent.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            // Show result screen
            showScreen(resultScreen);
        }

        function takeScreenshot() {
            html2canvas(resultScreen).then(canvas => {
                const link = document.createElement('a');
                link.download = `Quiz_Results_${studentName.textContent.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function showReviewScreen() {
            // Clear previous content
            reviewContainer.innerHTML = '';

            // Create review items for each question
            userAnswers.forEach((answer, index) => {
                if (!answer) {
                    // Create a review item for unanswered questions
                    const reviewItem = document.createElement('div');
                    reviewItem.className = 'review-question incorrect';

                    const questionHeader = document.createElement('div');
                    questionHeader.className = 'review-question-header';
                    questionHeader.innerHTML = `<strong>Question ${index + 1}:</strong> ${questions[index].question}`;

                    const answerText = document.createElement('div');
                    answerText.className = 'review-answer incorrect';
                    answerText.innerHTML = `<strong>Your Answer:</strong> No answer provided<br><strong>Correct Answer:</strong> ${questions[index].answer}`;

                    const explanationDiv = document.createElement('div');
                    explanationDiv.className = 'review-explanation';
                    const explanationText = questions[index].explanation && questions[index].explanation.toLowerCase() !== "none" ? 
                        questions[index].explanation : "No explanations are given for this question.";
                    explanationDiv.innerHTML = `<strong>Explanation:</strong> ${explanationText}`;

                    reviewItem.appendChild(questionHeader);
                    reviewItem.appendChild(answerText);
                    reviewItem.appendChild(explanationDiv);

                    reviewContainer.appendChild(reviewItem);
                    return;
                }

                const reviewItem = document.createElement('div');
                reviewItem.className = `review-question ${answer.isCorrect ? 'correct' : 'incorrect'}`;

                const questionHeader = document.createElement('div');
                questionHeader.className = 'review-question-header';
                questionHeader.innerHTML = `<strong>Question ${index + 1}:</strong> ${answer.questionText}`;

                const answerText = document.createElement('div');
                answerText.className = `review-answer ${answer.isCorrect ? 'correct' : 'incorrect'}`;
                answerText.innerHTML = `<strong>Your Answer:</strong> ${answer.userAnswer}`;

                if (!answer.isCorrect) {
                    answerText.innerHTML += `<br><strong>Correct Answer:</strong> ${answer.correctAnswer}`;
                }

                const explanationDiv = document.createElement('div');
                explanationDiv.className = 'review-explanation';
                const explanationText = answer.explanation && answer.explanation.toLowerCase() !== "none" ? 
                    answer.explanation : "No explanations are given for this question.";
                explanationDiv.innerHTML = `<strong>Explanation:</strong> ${explanationText}`;

                reviewItem.appendChild(questionHeader);
                reviewItem.appendChild(answerText);
                reviewItem.appendChild(explanationDiv);

                reviewContainer.appendChild(reviewItem);
            });

            showScreen(reviewScreen);
        }

        function backToResults() {
            showScreen(resultScreen);
        }

        function goToHome() {
            // Reset app state
            questions = [];
            currentQuestion = 0;
            userAnswers = [];
            quizCompleted = false;
            nameInput.value = '';
            sheetIdInput.value = '';

            // Stop timer if running
            if (timerInterval) {
                stopTimer();
            }

            // Show welcome screen
            showScreen(welcomeScreen);
        }

        // Allow pressing Enter to submit answers for typing questions
        answerInput.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                const nextIndex = currentQuestion + 1;
                if (nextIndex < questions.length) {
                    showQuestion(nextIndex);
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const pv = document.getElementById('pageviews');

            if (pv !== null) {
                // Strip trailing slash (if any) so the path matches GoatCounter
                const uri = location.pathname.replace(/\/$/, '');
                // Build the JSON endpoint URL for your domain
                const url = `https://linsnotes.goatcounter.com/counter/${encodeURIComponent(uri)}.json`;

                fetch(url)
                    .then((response) => response.json())
                    .then((data) => {
                        // 'data.count' comes back as a string with possible whitespace
                        const count = data.count.replace(/\s/g, '');
                        // Format it with commas, etc.
                        pv.innerText = new Intl.NumberFormat().format(count);
                        pv.classList.remove('loading');
                    })
                    .catch((error) => {
                        // Fallback if something goes wrong
                        pv.innerText = '1';
                        pv.classList.remove('loading');
                    });
            }
        });
    </script>
</body>

</html>
