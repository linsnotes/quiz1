<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- GoatCounter script for counting pageviews -->
    <script data-goatcounter="https://linsnotes.goatcounter.com/count" async src="https://gc.zgo.at/count.js"></script>
    <style>
        :root {
            --primary-color: #0071e3;
            --error-color: #ff3b30;
            --success-color: #34c759;
            --gray-light: #f5f5f7;
            --gray-medium: #d2d2d7;
            --gray-dark: #86868b;
            --text-color: #1d1d1f;
            --background-color: #ffffff;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'San Francisco', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        header.hidden {
            display: none;
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        h2 {
            font-size: 1.75rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            letter-spacing: -0.01em;
        }

        h3 {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        p {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: var(--gray-dark);
        }

        .screen {
            display: none;
            padding: 2rem;
            background-color: var(--background-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            animation: fadeIn 0.5s ease;
        }

        #resultScreen {
            animation: none !important;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        input[type="text"] {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            border: 1px solid var(--gray-medium);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 113, 227, 0.3);
        }

        .btn {
            display: inline-block;
            padding: 0.75rem 2rem;
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .btn:hover {
            background-color: #0058b0;
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background-color: var(--gray-light);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: var(--gray-medium);
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .center-btn {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 4px solid rgba(0, 113, 227, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .question-card {
            margin-bottom: 2rem;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .question-number {
            font-size: 0.875rem;
            color: var(--gray-dark);
        }

        .timer {
            font-size: 0.875rem;
            color: var(--gray-dark);
        }

        .submit-wrapper {
            text-align: center;
        }

        .submit-header-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: 20px;
        }

        .question-text {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
        }

        .reading-material {
            background-color: var(--gray-light);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            font-style: normal;
        }

        .mcq-options {
            display: grid;
            gap: 1rem;
        }

        .mcq-option {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--gray-medium);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .mcq-option:hover {
            background-color: var(--gray-light);
        }

        .mcq-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(0, 113, 227, 0.1);
        }

        .mcq-option-letter {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 30px;
            height: 30px;
            background-color: var(--gray-light);
            border-radius: 50%;
            margin-right: 0.75rem;
            font-weight: 500;
        }

        .typing-answer {
            margin-top: 1rem;
        }

        .hint-container,
        .explanation-container {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: var(--border-radius);
            background-color: var(--gray-light);
            display: none;
        }

        .hint-container.active,
        .explanation-container.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .result-summary {
            text-align: center;
            margin-bottom: 2rem;
        }

        .result-score {
            font-size: 3rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .result-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .result-detail-card {
            padding: 1.5rem;
            background-color: var(--gray-light);
            border-radius: var(--border-radius);
            text-align: center;
        }

        .result-detail-value {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .result-detail-label {
            font-size: 0.875rem;
            color: var(--gray-dark);
        }

        .review-question {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            background-color: var(--gray-light);
        }

        .review-question.correct {
            border-left: 4px solid var(--success-color);
        }

        .review-question.incorrect {
            border-left: 4px solid var(--error-color);
        }

        .review-answer {
            margin-top: 1rem;
            font-weight: 500;
        }

        .review-answer.correct {
            color: var(--success-color);
        }

        .review-answer.incorrect {
            color: var(--error-color);
        }

        .review-explanation {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-medium);
        }

        /* Visitor counter styles */
        #visitor-counter {
            display: inline-block;
            margin: 0.5rem auto 1rem;
            padding: 0.4rem 1rem;
            background-color: var(--gray-light);
            border-radius: 20px;
            font-size: 0.875rem;
            color: var(--gray-dark);
            transition: var(--transition);
        }

        #pageviews {
            font-weight: 600;
            color: var(--primary-color);
            position: relative;
        }

        #pageviews.loading {
            animation: pulse 1.5s infinite ease-in-out;
            padding: 0;
            display: inline;
        }

        /* New style for submission notification */
        .submission-notification {
            background-color: var(--success-color);
            color: white;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.5rem;
            }

            .container {
                padding: 1rem;
            }

            .screen {
                padding: 1.5rem;
            }

            /* Updated: Keep buttons in one row for mobile */
            .btn-group {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
            }

            .btn {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
                white-space: nowrap;
                flex: 1 1 auto;
                min-width: 0;
            }

            /* Updated: Make quiz results more compact on mobile */
            .result-details {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .result-detail-card {
                padding: 0.75rem;
            }

            .result-detail-value {
                font-size: 1.25rem;
                margin-bottom: 0.25rem;
            }

            .result-detail-label {
                font-size: 0.75rem;
            }

            .question-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .submit-wrapper {
                margin-top: 0.5rem;
                width: 100%;
            }

            .submit-header-btn {
                width: 100%;
            }

            /* Make navigation buttons stay in one row on mobile */
            .navigation-buttons {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .navigation-buttons .btn {
                flex: 1;
                padding: 0.75rem 0.5rem;
                min-width: 0;
            }
        }

        #studentName {
            font-weight: 600;
        }
    </style>
</head>

<body>
    <div class="container">
        <header id="appHeader">
            <h1>Quiz App</h1>
            <div id="visitor-counter">
                <span>Welcome!</span> <span id="pageviews" class="loading">Loading...</span> <span>visits</span>
            </div>
            <p>This website runs entirely in your web browser. No personal data is collected or stored on any server.
                Your name is used solely for your quiz summary and is removed when you refresh the page.</p>
        </header>

        <div id="welcomeScreen" class="screen active">
            <h2>Welcome to the Quiz App</h2>
            <div class="input-group">
                <label for="nameInput">Your Name</label>
                <input type="text" id="nameInput" placeholder="Enter your name">
            </div>
            <div class="input-group">
                <label for="sheetIdInput">Quiz ID</label>
                <input type="text" id="sheetIdInput" value="1QfXLwOvU4XqkxBlQn3xpMrTVb0ydG4uSbjf1hKumwuw" placeholder="Enter the Quiz ID">
                <p>Please obtain the Quiz ID from your teacher.</p>
            </div>
            <div class="center-btn">
                <button id="startQuizBtn" class="btn">Start Quiz</button>
            </div>
        </div>

        <!-- New screen for Google Web App link input -->
        <div id="webAppLinkScreen" class="screen">
            <h2>Submit Quiz Results</h2>
            <p>If your teacher provided a Google Web App link, you can submit your quiz results directly to them.</p>
            <div class="input-group">
                <label for="webAppLinkInput">Google Web App Link (Optional)</label>
                <input type="text" id="webAppLinkInput" placeholder="Paste Google Web App link here">
                <p>This link will be used to send your quiz results to your teacher.</p>
            </div>
            <div class="btn-group">
                <button id="skipWebAppLinkBtn" class="btn btn-secondary">Skip</button>
                <button id="confirmWebAppLinkBtn" class="btn" disabled>OK</button>
            </div>
        </div>

        <div id="loadingScreen" class="screen">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading questions...</p>
            </div>
        </div>

        <div id="questionScreen" class="screen">
            <div class="question-header">
                <div class="question-number">Question <span id="currentQuestionNumber">1</span> of <span
                        id="totalQuestions">10</span></div>
                <div class="submit-wrapper">
                    <button id="submitAllBtn" class="btn submit-header-btn">Submit All Answers</button>
                </div>
                <div class="timer">Time: <span id="timerValue">00:00</span></div>
            </div>
            <div class="question-card">
                <div id="readingMaterial" class="reading-material" style="display: none;"></div>
                <div id="questionText" class="question-text"></div>
                <div id="mcqOptions" class="mcq-options"></div>
                <div id="typingAnswer" class="typing-answer" style="display: none;">
                    <input type="text" id="answerInput" placeholder="Type your answer here">
                </div>
                <div id="hintContainer" class="hint-container">
                    <h3>Hint:</h3>
                    <p id="hintText"></p>
                </div>
                <div class="navigation-buttons">
                    <button id="prevQuestionBtn" class="btn btn-secondary">Previous</button>
                    <button id="showHintBtn" class="btn btn-secondary">Show Hint</button>
                    <button id="nextQuestionBtn" class="btn btn-secondary">Next</button>
                </div>
            </div>
        </div>

        <div id="resultScreen" class="screen">
            <div id="submissionNotification" class="submission-notification" style="display: none;">
                Quiz data has been submitted to teacher.
            </div>
            <div class="result-summary">
                <h2>Quiz Results</h2>
                <p>Well done, <span id="studentName"></span>!</p>
                <div class="result-score"><span id="correctAnswers">0</span>/<span id="totalQuestionsResult">0</span>
                </div>
            </div>
            <div class="result-details">
                <div class="result-detail-card">
                    <div class="result-detail-value" id="totalQuestionsAttempted">0</div>
                    <div class="result-detail-label">Questions Attempted</div>
                </div>
                <div class="result-detail-card">
                    <div class="result-detail-value" id="correctAnswersCount">0</div>
                    <div class="result-detail-label">Correct Answers</div>
                </div>
                <div class="result-detail-card">
                    <div class="result-detail-value" id="incorrectAnswersCount">0</div>
                    <div class="result-detail-label">Incorrect Answers</div>
                </div>
                <div class="result-detail-card">
                    <div class="result-detail-value" id="timeSpent">00:00</div>
                    <div class="result-detail-label">Time Spent</div>
                </div>
            </div>
            <div class="btn-group">
                <button id="screenshotBtn" class="btn">Screenshot Result</button>
                <button id="reviewBtn" class="btn">Review All Questions</button>
                <button id="homeBtn" class="btn">Back to Home</button>
            </div>
        </div>

        <div id="reviewScreen" class="screen">
            <h2>Review All Questions</h2>
            <div id="reviewContainer"></div>
            <div class="btn-group">
                <button id="backToResultsBtn" class="btn">Back to Results</button>
                <button id="reviewHomeBtn" class="btn">Back to Home</button>
            </div>
        </div>
    </div>

    <script>
       // DOM Elements
        const appHeader = document.getElementById('appHeader');
        const welcomeScreen = document.getElementById('welcomeScreen');
        const loadingScreen = document.getElementById('loadingScreen');
        const questionScreen = document.getElementById('questionScreen');
        const resultScreen = document.getElementById('resultScreen');
        const reviewScreen = document.getElementById('reviewScreen');
        // New DOM elements for Web App link screen
        const webAppLinkScreen = document.getElementById('webAppLinkScreen');
        const webAppLinkInput = document.getElementById('webAppLinkInput');
        const skipWebAppLinkBtn = document.getElementById('skipWebAppLinkBtn');
        const confirmWebAppLinkBtn = document.getElementById('confirmWebAppLinkBtn');
        const submissionNotification = document.getElementById('submissionNotification');

        const nameInput = document.getElementById('nameInput');
        const sheetIdInput = document.getElementById('sheetIdInput');
        const startQuizBtn = document.getElementById('startQuizBtn');

        const currentQuestionNumber = document.getElementById('currentQuestionNumber');
        const totalQuestions = document.getElementById('totalQuestions');
        const timerValue = document.getElementById('timerValue');
        const readingMaterial = document.getElementById('readingMaterial');
        const questionText = document.getElementById('questionText');
        const mcqOptions = document.getElementById('mcqOptions');
        const typingAnswer = document.getElementById('typingAnswer');
        const answerInput = document.getElementById('answerInput');
        const prevQuestionBtn = document.getElementById('prevQuestionBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const showHintBtn = document.getElementById('showHintBtn');
        const submitAllBtn = document.getElementById('submitAllBtn');
        const hintContainer = document.getElementById('hintContainer');
        const hintText = document.getElementById('hintText');

        const studentName = document.getElementById('studentName');
        const totalQuestionsResult = document.getElementById('totalQuestionsResult');
        const totalQuestionsAttempted = document.getElementById('totalQuestionsAttempted');
        const correctAnswers = document.getElementById('correctAnswers');
        const correctAnswersCount = document.getElementById('correctAnswersCount');
        const incorrectAnswersCount = document.getElementById('incorrectAnswersCount');
        const timeSpent = document.getElementById('timeSpent');
        const screenshotBtn = document.getElementById('screenshotBtn');
        const reviewBtn = document.getElementById('reviewBtn');
        const homeBtn = document.getElementById('homeBtn');

        const reviewContainer = document.getElementById('reviewContainer');
        const backToResultsBtn = document.getElementById('backToResultsBtn');
        const reviewHomeBtn = document.getElementById('reviewHomeBtn');

        // App State
        let questions = [];
        let currentQuestion = 0;
        let startTime;
        let timerInterval;
        let userAnswers = [];
        let quizCompleted = false;
        let hintVisible = false;
        let quizTimeLimit = null; // Global time limit in minutes
        // New state variable for Google Web App link
        let webAppLink = null;

        // Event Listeners
        startQuizBtn.addEventListener('click', startQuiz);
        prevQuestionBtn.addEventListener('click', showPreviousQuestion);
        nextQuestionBtn.addEventListener('click', showNextQuestion);
        showHintBtn.addEventListener('click', toggleHint);
        submitAllBtn.addEventListener('click', submitAllAnswers);
        screenshotBtn.addEventListener('click', takeScreenshot);
        reviewBtn.addEventListener('click', showReviewScreen);
        homeBtn.addEventListener('click', goToHome);
        backToResultsBtn.addEventListener('click', backToResults);
        reviewHomeBtn.addEventListener('click', goToHome);
        // New event listeners for Web App link handling
        skipWebAppLinkBtn.addEventListener('click', skipWebAppLink);
        confirmWebAppLinkBtn.addEventListener('click', confirmWebAppLink);
        webAppLinkInput.addEventListener('input', validateWebAppLink);

        // Add global event listener for answer input
        answerInput.addEventListener('input', function() {
            if (currentQuestion < questions.length) {
                saveUserAnswer(this.value);
            }
        });

        // Functions
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            screen.classList.add('active');

            // Hide the header for all screens except welcome screen
            if (screen === welcomeScreen) {
                appHeader.classList.remove('hidden');
            } else {
                appHeader.classList.add('hidden');
            }
        }

        // Modified startQuiz function to show Web App link screen
        function startQuiz() {
            const name = nameInput.value.trim();
            const sheetId = sheetIdInput.value.trim();

            if (!name) {
                alert('Please enter your name. Your name is used solely for your quiz summary and is removed when you refresh the page.');
                return;
            }

            if (!sheetId) {
                alert('Please enter a Quiz ID. You can obtain from your teacher.');
                return;
            }

            // Set the student name
            studentName.textContent = name;
            
            // Show the Web App link input screen
            showScreen(webAppLinkScreen);
        }

        // Function to validate Web App link
        function validateWebAppLink() {
            const link = webAppLinkInput.value.trim();
            
            // Basic validation - enable OK button if there's any text
            if (link && (link.startsWith('https://') || link.startsWith('http://'))) {
                confirmWebAppLinkBtn.disabled = false;
            } else {
                confirmWebAppLinkBtn.disabled = true;
            }
        }

        // Function to skip Web App link input
        function skipWebAppLink() {
            webAppLink = null;
            loadQuizQuestions();
        }

        // Function to confirm Web App link
        function confirmWebAppLink() {
            webAppLink = webAppLinkInput.value.trim();
            loadQuizQuestions();
        }

        // Function to load quiz questions
        function loadQuizQuestions() {
            showScreen(loadingScreen);
            
            const sheetId = sheetIdInput.value.trim();

            fetchQuestionData(sheetId)
                .then(data => {
                    if (data && data.length > 0) {
                        questions = data;
                        totalQuestions.textContent = questions.length;
                        totalQuestionsResult.textContent = questions.length;

                        // Extract quiz time limit from the first row if provided
                        if (questions[0].timeLimit && !isNaN(questions[0].timeLimit)) {
                            quizTimeLimit = parseInt(questions[0].timeLimit, 10);
                        }

                        // Preprocess MCQ questions to shuffle options only once
                        questions.forEach(question => {
                            if (question.type === 'MCQ') {
                                let options = (question.mcqOptions || '')
                                    .split('#')
                                    .map(option => option.trim())
                                    .filter(option => option !== '');
                                const correctAnswer = (question.answer || '').trim();
                                const shuffledOptions = shuffleArray(options);
                                const letters = ['A', 'B', 'C', 'D'];
                                question.shuffledOptions = shuffledOptions.map((option, index) => ({
                                    letter: letters[index],
                                    option: option,
                                    isCorrect: option.toLowerCase().trim() === correctAnswer.toLowerCase().trim()
                                }));
                            }
                        });

                        // Initialize user answers array with empty objects instead of null
                        userAnswers = Array(questions.length).fill().map(() => ({
                            userAnswer: '',
                            isAnswered: false,
                            isCorrect: false
                        }));

                        // Start timer
                        startTime = new Date();
                        startTimer();

                        // Show first question
                        showQuestion(0);
                        showScreen(questionScreen);
                    } else {
                        alert('No questions found. Please ensure the Quiz ID is correct and try again.');
                        showScreen(welcomeScreen);
                    }
                })
                .catch(error => {
                    console.error('Error fetching questions:', error);
                    alert('Error loading questions. Please ensure the Quiz ID is correct and try again.');
                    showScreen(welcomeScreen);
                });
        }

        async function fetchQuestionData(sheetId) {
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=xlsx`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('Failed to fetch spreadsheet');
                }

                const arrayBuffer = await response.arrayBuffer();
                const data = new Uint8Array(arrayBuffer);
                const workbook = XLSX.read(data, { type: 'array' });

                // Get the first sheet and convert to an array of arrays
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                // If there are fewer than 2 rows, there is no data (since row 1 is header)
                if (!rows || rows.length < 2) {
                    return [];
                }

                // Define the expected column order, including the new "timeLimit" column
                const expectedOrder = [
                    'no',              // Question number
                    'question',        // Question text
                    'answer',          // Answer
                    'type',            // Question type
                    'mcqOptions',      // Multiple choice options
                    'readingMaterial', // Reading material
                    'hint',            // Hint
                    'explanation',     // Explanation
                    'timeLimit'        // Quiz time limit in minutes (new column)
                ];

                const questions = [];
                // Loop through rows starting from index 1 (row 2 in the sheet)
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    // Stop processing if the row is completely empty
                    if (row.every(cell => cell === undefined || cell === "")) {
                        break;
                    }
                    const rowData = {};
                    expectedOrder.forEach((key, index) => {
                        rowData[key] = row[index] || "";
                    });
                    questions.push(rowData);
                }

                return questions;
            } catch (error) {
                console.error('Error fetching or parsing the spreadsheet:', error);
                throw error;
            }
        }

        // Utility function to shuffle an array (Fisher-Yates shuffle)
        function shuffleArray(array) {
            const arr = [...array];
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }

        function showQuestion(index) {
            // Save current answer before moving to another question
            if (currentQuestion >= 0 && currentQuestion < questions.length && questions[currentQuestion] && questions[currentQuestion].type !== 'MCQ') {
                const currentInputValue = answerInput.value.trim();
                if (currentInputValue) {
                    saveUserAnswer(currentInputValue);
                }
            }

            if (index < 0) {
                index = 0;
            } else if (index >= questions.length) {
                index = questions.length - 1;
            }

            const question = questions[index];
            currentQuestion = index;
            currentQuestionNumber.textContent = index + 1;

            // Reset UI elements
            mcqOptions.innerHTML = '';
            typingAnswer.style.display = 'none';
            hintContainer.classList.remove('active');
            hintVisible = false;
            showHintBtn.textContent = 'Show Hint';

            // Set question text
            questionText.textContent = question.question || '';

            // Set reading material if available
            const rm = String(question.readingMaterial || "").trim().toLowerCase();
            if (!["", "none", "na"].includes(rm)) {
                readingMaterial.textContent = question.readingMaterial;
                readingMaterial.style.display = 'block';
            } else {
                readingMaterial.style.display = 'none';
            }

            // Set hint text
            const hintValue = question.hint || '';
            hintText.textContent = hintValue && String(hintValue).trim() !== '' &&
                String(hintValue).toLowerCase() !== "none" ?
                hintValue : "No hints are provided for this question.";

            // Render question based on type
            if (question.type === 'MCQ') {
                renderMCQQuestion(question);
            } else {
                renderTypingQuestion(index);
            }
        }

        function renderMCQQuestion(question) {
            mcqOptions.innerHTML = '';

            // Use the preprocessed shuffled options
            const optionsToRender = question.shuffledOptions || [];

            // Render options
            optionsToRender.forEach((optionObj) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'mcq-option';
                optionElement.dataset.option = optionObj.option;
                optionElement.dataset.letter = optionObj.letter;

                const letterElement = document.createElement('div');
                letterElement.className = 'mcq-option-letter';
                letterElement.textContent = optionObj.letter;

                const textElement = document.createElement('div');
                textElement.className = 'mcq-option-text';
                textElement.textContent = optionObj.option;

                optionElement.appendChild(letterElement);
                optionElement.appendChild(textElement);

                // Check if this option was previously selected
                if (userAnswers[currentQuestion] &&
                    userAnswers[currentQuestion].userAnswer &&
                    userAnswers[currentQuestion].userAnswer.toLowerCase().trim() === optionObj.option.toLowerCase().trim()) {
                    optionElement.classList.add('selected');
                }

                optionElement.addEventListener('click', () => {
                    document.querySelectorAll('.mcq-option').forEach(el => el.classList.remove('selected'));
                    optionElement.classList.add('selected');

                    // Save this answer
                    saveUserAnswer(optionObj.option);
                });

                mcqOptions.appendChild(optionElement);
            });
        }

        function renderTypingQuestion(index) {
            typingAnswer.style.display = 'block';

            // Set previous answer if exists
            if (userAnswers[index] && userAnswers[index].userAnswer) {
                answerInput.value = userAnswers[index].userAnswer;
            } else {
                answerInput.value = '';
            }

            answerInput.focus();
        }

        function saveUserAnswer(answer) {
            if (currentQuestion >= questions.length) return;

            const question = questions[currentQuestion];
            let userAnswer = String(answer || '').trim();
            let correctAnswer = String(question.answer || '').trim();

            // Check if input is empty
            if (userAnswer === '') {
                userAnswers[currentQuestion] = {
                    questionNo: question.no || currentQuestion + 1,
                    questionText: question.question || '',
                    userAnswer: '',
                    correctAnswer: correctAnswer,
                    isCorrect: false,
                    questionType: question.type || 'Text',
                    explanation: question.explanation || '',
                    isAnswered: false
                };
                return;
            }

            // Simple comparison for text answers
            let isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();

            // For numeric values, try numeric comparison
            if (!isCorrect) {
                // Try to extract numeric values
                const userNum = parseFloat(userAnswer.replace(/[^\d.-]/g, ''));
                const correctNum = parseFloat(correctAnswer.replace(/[^\d.-]/g, ''));

                // If both are valid numbers, compare them with a small tolerance
                if (!isNaN(userNum) && !isNaN(correctNum)) {
                    isCorrect = Math.abs(userNum - correctNum) < 0.0001;
                }
            }

            // Save the answer
            userAnswers[currentQuestion] = {
                questionNo: question.no || currentQuestion + 1,
                questionText: question.question || '',
                userAnswer: userAnswer,
                correctAnswer: correctAnswer,
                isCorrect: isCorrect,
                questionType: question.type || 'Text',
                explanation: question.explanation || '',
                isAnswered: true
            };
        }

        function showPreviousQuestion() {
            if (currentQuestion === 0) {
                window.alert("This is the first question.");
                return;
            }
            showQuestion(currentQuestion - 1);
        }

        function showNextQuestion() {
            if (currentQuestion === questions.length - 1) {
                window.alert("This is the last question. If you have completed all questions, you can click the 'Submit All Answers' button to end the quiz.");
                return;
            }
            showQuestion(currentQuestion + 1);
        }

        function toggleHint() {
            hintVisible = !hintVisible;

            if (hintVisible) {
                hintContainer.classList.add('active');
                showHintBtn.textContent = 'Hide Hint';
            } else {
                hintContainer.classList.remove('active');
                showHintBtn.textContent = 'Show Hint';
            }
        }

        function submitAllAnswers() {
            // Save current answer before submitting
            if (questions[currentQuestion] && questions[currentQuestion].type !== 'MCQ') {
                const currentInputValue = answerInput.value.trim();
                if (currentInputValue) {
                    saveUserAnswer(currentInputValue);
                }
            }

            // Check if any questions are unanswered
            const unansweredQuestions = [];

            for (let i = 0; i < userAnswers.length; i++) {
                const answer = userAnswers[i];
                if (!answer || !answer.isAnswered) {
                    unansweredQuestions.push(i + 1);
                }
            }

            if (unansweredQuestions.length > 0) {
                const confirmSubmit = confirm(`You haven't answered question(s) ${unansweredQuestions.join(', ')}. Do you want to submit anyway?`);
                if (!confirmSubmit) {
                    showQuestion(unansweredQuestions[0] - 1);
                    return;
                }
            }

            // Finish the quiz
            finishQuiz();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const now = new Date();
                const elapsedMilliseconds = now - startTime;
                const elapsedSeconds = Math.floor(elapsedMilliseconds / 1000);

                // If a quiz time limit is set, count down from that limit
                if (quizTimeLimit !== null) {
                    const totalSeconds = quizTimeLimit * 60;
                    const remainingSeconds = totalSeconds - elapsedSeconds;
                    if (remainingSeconds <= 0) {
                        timerValue.textContent = "00:00";
                        finishQuiz();
                    } else {
                        const minutes = Math.floor(remainingSeconds / 60);
                        const seconds = remainingSeconds % 60;
                        timerValue.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                    }
                } else {
                    // Default behavior: count up
                    const minutes = Math.floor(elapsedSeconds / 60);
                    const seconds = elapsedSeconds % 60;
                    timerValue.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        // Function to build stats string for submission
        function buildStatsString() {
            return userAnswers.map((answer, index) => {
                const questionNum = index + 1;
                const result = answer.isAnswered ? 
                    (answer.isCorrect ? "right" : "wrong") : 
                    "unanswered";
                return `${questionNum}-${result}`;
            }).join(';');
        }

        async function submitQuizData(quizData) {
            if (!webAppLink) return false;

            // Skip fetch and use form submission directly
            return new Promise((resolve, reject) => {
                try {
                    // Create an invisible form
                    const form = document.createElement('form');
                    form.style.display = 'none';
                    form.method = 'POST';
                    form.action = webAppLink;
                    form.target = 'quizSubmitTarget';

                    // Add data as hidden inputs
                    for (const key in quizData) {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = key;
                        input.value = typeof quizData[key] === 'object' 
                            ? JSON.stringify(quizData[key]) 
                            : quizData[key].toString();
                        form.appendChild(input);
                    }

                    // Create a hidden iframe to target the form submission
                    const iframe = document.createElement('iframe');
                    iframe.name = 'quizSubmitTarget';
                    iframe.style.display = 'none';

                    // Handle response
                    iframe.onload = () => {
                        console.log("Quiz submitted successfully using form");
                        resolve(true);
                        // Clean up
                        setTimeout(() => {
                            document.body.removeChild(form);
                            document.body.removeChild(iframe);
                        }, 1000);
                    };

                    // Set a timeout in case of hanging
                    const timeoutId = setTimeout(() => {
                        console.log("Form submission timed out, but may have succeeded");
                        resolve(true); // Assume success to avoid blocking the user
                        // Clean up
                        if (document.body.contains(form)) document.body.removeChild(form);
                        if (document.body.contains(iframe)) document.body.removeChild(iframe);
                    }, 5000);

                    // Add elements to the DOM and submit
                    document.body.appendChild(iframe);
                    document.body.appendChild(form);
                    form.submit();
                } catch (formError) {
                    console.error("Error with form submission:", formError);
                    reject(false);
                }
            });
        }


        // Modified finishQuiz function to include submission logic
        async function finishQuiz() {
            stopTimer();
            quizCompleted = true;

            // Calculate results
            const totalAttempted = userAnswers.filter(answer => answer && answer.isAnswered).length;
            const correct = userAnswers.filter(answer => answer && answer.isCorrect && answer.isAnswered).length;
            const incorrect = totalAttempted - correct;

            // Update result screen
            totalQuestionsAttempted.textContent = totalAttempted;
            correctAnswers.textContent = correct;
            correctAnswersCount.textContent = correct;
            incorrectAnswersCount.textContent = incorrect;

            // Calculate time spent
            const endTime = new Date();
            const elapsedMilliseconds = endTime - startTime;
            const elapsedSeconds = Math.floor(elapsedMilliseconds / 1000);
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            const formattedTimeSpent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            timeSpent.textContent = formattedTimeSpent;

            // Submit data to Google Web App if a link was provided
            if (webAppLink) {
                // Prepare quiz data for submission
                const quizData = {
                    name: studentName.textContent,
                    quizId: sheetIdInput.value,
                    stats: buildStatsString(),
                    totalQuestions: questions.length,
                    questionsAttempted: totalAttempted,
                    correctAnswers: correct,
                    incorrectAnswers: incorrect,
                    timeSpent: formattedTimeSpent
                };
                
                // Submit quiz data
                const submitted = await submitQuizData(quizData);
                
                // Show success notification if submission was successful
                if (submitted) {
                    submissionNotification.style.display = 'block';
                }
            }

            // Show result screen
            showScreen(resultScreen);
        }

        function takeScreenshot() {
            const computedBg = window.getComputedStyle(resultScreen).backgroundColor;
            html2canvas(resultScreen, {
                backgroundColor: computedBg,
                scale: 2,
                useCORS: true,
                logging: false,
                allowTaint: true,
                letterRendering: true,
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Quiz_Results_${studentName.textContent.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();
            });
        }

        function showReviewScreen() {
            // Clear previous content
            reviewContainer.innerHTML = '';

            // Create review items for each question
            userAnswers.forEach((answer, index) => {
                const question = questions[index];

                if (!answer || !answer.isAnswered) {
                    // Create a review item for unanswered questions
                    const reviewItem = document.createElement('div');
                    reviewItem.className = 'review-question incorrect';

                    const questionHeader = document.createElement('div');
                    questionHeader.className = 'review-question-header';
                    questionHeader.innerHTML = `<strong>Question ${index + 1}:</strong> ${question.question || ''}`;

                    const answerText = document.createElement('div');
                    answerText.className = 'review-answer incorrect';
                    answerText.innerHTML = `<strong>Your Answer:</strong> No answer provided<br><strong>Correct Answer:</strong> ${question.answer || ''}`;

                    const explanationDiv = document.createElement('div');
                    explanationDiv.className = 'review-explanation';

                    // Safely get explanation text
                    let explanationText = "No explanations are given for this question.";
                    if (question.explanation && typeof question.explanation === 'string') {
                        const trimmedExplanation = question.explanation.trim();
                        if (trimmedExplanation !== '' && trimmedExplanation.toLowerCase() !== 'none') {
                            explanationText = trimmedExplanation;
                        }
                    }

                    explanationDiv.innerHTML = `<strong>Explanation:</strong> ${explanationText}`;

                    reviewItem.appendChild(questionHeader);
                    reviewItem.appendChild(answerText);
                    reviewItem.appendChild(explanationDiv);

                    reviewContainer.appendChild(reviewItem);
                    return;
                }

                const reviewItem = document.createElement('div');
                reviewItem.className = `review-question ${answer.isCorrect ? 'correct' : 'incorrect'}`;

                const questionHeader = document.createElement('div');
                questionHeader.className = 'review-question-header';
                questionHeader.innerHTML = `<strong>Question ${index + 1}:</strong> ${answer.questionText || ''}`;

                const answerText = document.createElement('div');
                answerText.className = `review-answer ${answer.isCorrect ? 'correct' : 'incorrect'}`;
                answerText.innerHTML = `<strong>Your Answer:</strong> ${answer.userAnswer || ''}`;

                if (!answer.isCorrect) {
                    answerText.innerHTML += `<br><strong>Correct Answer:</strong> ${answer.correctAnswer || ''}`;
                }

                const explanationDiv = document.createElement('div');
                explanationDiv.className = 'review-explanation';

                // Safely get explanation text
                let explanationText = "No explanations are given for this question.";
                if (answer.explanation && typeof answer.explanation === 'string') {
                    const trimmedExplanation = answer.explanation.trim();
                    if (trimmedExplanation !== '' && trimmedExplanation.toLowerCase() !== 'none') {
                        explanationText = trimmedExplanation;
                    }
                }

                explanationDiv.innerHTML = `<strong>Explanation:</strong> ${explanationText}`;

                reviewItem.appendChild(questionHeader);
                reviewItem.appendChild(answerText);
                reviewItem.appendChild(explanationDiv);

                reviewContainer.appendChild(reviewItem);
            });

            showScreen(reviewScreen);
        }

        function backToResults() {
            showScreen(resultScreen);
        }

        function goToHome() {
            // Reset app state
            questions = [];
            currentQuestion = 0;
            userAnswers = [];
            quizCompleted = false;
            nameInput.value = '';
            sheetIdInput.value = '';
            quizTimeLimit = null;
            webAppLink = null;
            webAppLinkInput.value = '';
            submissionNotification.style.display = 'none';
            confirmWebAppLinkBtn.disabled = true;

            // Stop timer if running
            if (timerInterval) {
                stopTimer();
            }

            // Show welcome screen
            showScreen(welcomeScreen);
        }

        // Allow pressing Enter to submit answers for typing questions
        answerInput.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                // Save the answer before navigating
                saveUserAnswer(answerInput.value);

                const nextIndex = currentQuestion + 1;
                if (nextIndex < questions.length) {
                    showQuestion(nextIndex);
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const pv = document.getElementById('pageviews');

            if (pv !== null) {
                // Strip trailing slash (if any) so the path matches GoatCounter
                const uri = location.pathname.replace(/\/$/, '');
                // Build the JSON endpoint URL for your domain
                const url = `https://linsnotes.goatcounter.com/counter/${encodeURIComponent(uri)}.json`;

                fetch(url)
                    .then((response) => response.json())
                    .then((data) => {
                        // 'data.count' comes back as a string with possible whitespace
                        const count = data.count.replace(/\s/g, '');
                        // Format it with commas, etc.
                        pv.innerText = new Intl.NumberFormat().format(count);
                        pv.classList.remove('loading');
                    })
                    .catch((error) => {
                        // Fallback if something goes wrong
                        pv.innerText = '1';
                        pv.classList.remove('loading');
                    });
            }
        });
    </script>
</body>

</html>
